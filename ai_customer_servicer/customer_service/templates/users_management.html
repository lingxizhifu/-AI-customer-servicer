{% load static %}
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·æƒé™ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{% static 'users_management.css' %}">
    <meta name="csrf-token" content="{{ csrf_token }}">
</head>
<body>
    {% include 'sidebar.html' with active_page='users' %}
    <div class="container" id="main-container">
        <div class="main-content">
            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="content">
                <div class="page-header">
                    <h1 class="page-title">
                        <div class="title-icon">ğŸ“‹</div>
                        ç”¨æˆ·ä¸æƒé™ç®¡ç†æ¨¡å—
                    </h1>
                </div>

                <div class="action-bar">
                    <div class="left-section">
                        <button class="btn btn-primary" id="add-admin-btn">+ æ·»åŠ ç®¡ç†å‘˜</button>
                        <button class="btn btn-secondary" id="export-btn">å¯¼å‡º</button>
                        <div class="search-box">
                            <span class="search-icon">ğŸ”</span>
                            <input type="text" placeholder="æœç´¢ç”¨æˆ·..." id="search-input">
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-secondary" id="batch-btn">æ‰¹é‡æ“ä½œ</button>
                        <button class="btn btn-primary" id="permission-config-btn">æƒé™é…ç½®</button>
                    </div>
                </div>

                <!-- ç”¨æˆ·è¡¨æ ¼ -->
                <div class="user-table" id="user-table">
                    <div class="table-header">
                        <div>
                            <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
                            å¤´åƒ
                        </div>
                        <div>ç”¨æˆ·å</div>
                        <div>è§’è‰²</div>
                        <div>ç™»å½•æ—¶é—´</div>
                        <div>ç®¡ç†æƒé™</div>
                        <div>çŠ¶æ€</div>
                        <div>æ“ä½œ</div>
                    </div>

                    <!-- åŠ¨æ€ç”Ÿæˆçš„ç”¨æˆ·è¡Œå°†åœ¨è¿™é‡Œæ’å…¥ -->
                </div>

                <!-- åˆ†é¡µ -->
                <div class="pagination" id="pagination">
                    <!-- åˆ†é¡µæŒ‰é’®å°†åŠ¨æ€ç”Ÿæˆ -->
                </div>

                <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
                <div id="loading" style="display: none; text-align: center; padding: 20px;">
                    <div>åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- CSRF Token -->
    {% csrf_token %}

    <script>
    let currentPage = 1;
    let totalPages = 1;
    let selectedUsers = new Set(); // ç”¨äºæ‰¹é‡æ“ä½œ

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        loadUsers();
        bindEvents();
    });

    // ç»‘å®šäº‹ä»¶
    function bindEvents() {
        // æœç´¢åŠŸèƒ½
        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('input', debounce(function() {
                currentPage = 1;
                loadUsers();
            }, 300));
        }
        
        // æ·»åŠ ç®¡ç†å‘˜æŒ‰é’®
        const addAdminBtn = document.getElementById('add-admin-btn');
        if (addAdminBtn) {
            addAdminBtn.addEventListener('click', showAddUserModal);
        }
        
        // å¯¼å‡ºæŒ‰é’®
        const exportBtn = document.getElementById('export-btn');
        if (exportBtn) {
            exportBtn.addEventListener('click', exportUsers);
        }
        
        // æ‰¹é‡æ“ä½œæŒ‰é’®
        const batchBtn = document.getElementById('batch-btn');
        if (batchBtn) {
            batchBtn.addEventListener('click', showBatchOperations);
        }

        // æƒé™é…ç½®æŒ‰é’®
        const permissionBtn = document.getElementById('permission-config-btn');
        if (permissionBtn) {
            permissionBtn.addEventListener('click', showPermissionConfigModal);
        }
    }

    // åŠ è½½ç”¨æˆ·åˆ—è¡¨
    async function loadUsers() {
        const loading = document.getElementById('loading');
        loading.style.display = 'block';
        
        try {
            const searchKeyword = document.getElementById('search-input')?.value || '';
            const url = `/api/users/?page=${currentPage}&search=${encodeURIComponent(searchKeyword)}`;
            
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data.error) {
                showMessage(data.error, 'error');
                return;
            }
            
            renderUsers(data.users);
            updatePagination(data);
            totalPages = data.total_pages;
            
        } catch (error) {
            console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
            showMessage('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥', 'error');
        } finally {
            loading.style.display = 'none';
        }
    }

    // æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨
    function renderUsers(users) {
        const tableContainer = document.getElementById('user-table');
        const header = tableContainer.querySelector('.table-header');
        
        // æ¸…ç©ºç°æœ‰æ•°æ®ï¼Œä¿ç•™è¡¨å¤´
        const rows = tableContainer.querySelectorAll('.table-row');
        rows.forEach(row => row.remove());
        
        users.forEach((user, index) => {
            const row = createUserRow(user, index);
            tableContainer.appendChild(row);
        });
        
        // é‡ç½®é€‰æ‹©çŠ¶æ€
        selectedUsers.clear();
        updateBatchButton();
        const selectAll = document.getElementById('select-all');
        if (selectAll) selectAll.checked = false;
    }

    // åˆ›å»ºç”¨æˆ·è¡Œ
    function createUserRow(user, index) {
        const row = document.createElement('div');
        row.className = `table-row ${index % 2 === 1 ? 'highlight' : ''}`;
        row.dataset.userId = user.id;
        
        row.innerHTML = `
            <div>
                <input type="checkbox" class="user-checkbox" value="${user.id}" onchange="toggleUserSelection(${user.id})">
                <div class="user-avatar-table" style="background: ${user.avatar_color};">${user.avatar_text}</div>
            </div>
            <div>${user.username}</div>
            <div><span class="role-text">${user.role}</span></div>
            <div>${user.last_login}</div>
            <div>${user.permissions}</div>
            <div class="status-${user.is_online ? 'active' : 'inactive'}">${user.status}</div>
            <div class="action-buttons">
                <button class="action-icon edit-icon" title="ç¼–è¾‘" onclick="editUser(${user.id})">âœï¸</button>
                <button class="action-icon delete-icon" title="åˆ é™¤" onclick="deleteUser(${user.id})">ğŸ—‘ï¸</button>
                <button class="action-icon toggle-icon" title="${user.is_active ? 'ç¦ç”¨' : 'æ¿€æ´»'}" 
                        onclick="toggleUserStatus(${user.id})">${user.is_active ? 'ğŸ”’' : 'ğŸ”“'}</button>
            </div>
        `;
        
        return row;
    }

    // å…¨é€‰/å–æ¶ˆå…¨é€‰
    function toggleSelectAll() {
        const selectAll = document.getElementById('select-all');
        const checkboxes = document.querySelectorAll('.user-checkbox');
        
        checkboxes.forEach(checkbox => {
            checkbox.checked = selectAll.checked;
            const userId = parseInt(checkbox.value);
            if (selectAll.checked) {
                selectedUsers.add(userId);
            } else {
                selectedUsers.delete(userId);
            }
        });
        
        updateBatchButton();
    }

    // æ˜¾ç¤ºæ·»åŠ ç”¨æˆ·æ¨¡æ€æ¡†
    function showAddUserModal() {
        const modal = createUserModal();
        document.body.appendChild(modal);
        modal.style.display = 'block';
    }

    // åˆ›å»ºç”¨æˆ·æ¨¡æ€æ¡†
    function createUserModal(user = null) {
        const isEdit = user !== null;
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'userModal';
        
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h2>${isEdit ? 'ç¼–è¾‘ç”¨æˆ·' : 'æ·»åŠ ç”¨æˆ·'}</h2>
                    <span class="close" onclick="closeModal('userModal')">&times;</span>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <div class="form-group">
                            <label>ç”¨æˆ·å *</label>
                            <input type="text" id="username" name="username" required 
                                   value="${user ? user.username : ''}" ${isEdit ? 'readonly' : ''}>
                        </div>
                        <div class="form-group">
                            <label>é‚®ç®±</label>
                            <input type="email" id="email" name="email" 
                                   value="${user ? (user.email || '') : ''}">
                        </div>
                        <div class="form-group">
                            <label>å§“</label>
                            <input type="text" id="first_name" name="first_name" 
                                   value="${user ? (user.first_name || '') : ''}">
                        </div>
                        <div class="form-group">
                            <label>å</label>
                            <input type="text" id="last_name" name="last_name" 
                                   value="${user ? (user.last_name || '') : ''}">
                        </div>
                        <div class="form-group">
                            <label>è§’è‰² *</label>
                            <select id="role" name="role" required>
                                <option value="viewer" ${user && user.role === 'viewer' ? 'selected' : ''}>æŸ¥çœ‹å‘˜</option>
                                <option value="editor" ${user && user.role === 'editor' ? 'selected' : ''}>ç¼–è¾‘å‘˜</option>
                                <option value="admin" ${user && user.role === 'admin' ? 'selected' : ''}>è¶…çº§ç®¡ç†å‘˜</option>
                            </select>
                        </div>
                        ${!isEdit ? `
                        <div class="form-group">
                            <label>å¯†ç  *</label>
                            <input type="password" id="password" name="password" required>
                        </div>
                        <div class="form-group">
                            <label>ç¡®è®¤å¯†ç  *</label>
                            <input type="password" id="confirm_password" name="confirm_password" required>
                        </div>
                        ` : `
                        <div class="form-group">
                            <label>æ–°å¯†ç ï¼ˆç•™ç©ºåˆ™ä¸ä¿®æ”¹ï¼‰</label>
                            <input type="password" id="password" name="password">
                        </div>
                        `}
                        ${isEdit ? `
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="is_active" name="is_active" 
                                       ${user && user.is_active ? 'checked' : ''}>
                                è´¦æˆ·æ¿€æ´»
                            </label>
                        </div>
                        ` : ''}
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('userModal')">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="${isEdit ? `updateUser(${user.id})` : 'createUser()'}">${isEdit ? 'æ›´æ–°' : 'åˆ›å»º'}</button>
                </div>
            </div>
        `;
        
        return modal;
    }

    // åˆ›å»ºç”¨æˆ·
    async function createUser() {
        const form = document.getElementById('userForm');
        const formData = new FormData(form);
        
        // éªŒè¯å¯†ç 
        const password = formData.get('password');
        const confirmPassword = formData.get('confirm_password');
        
        if (password !== confirmPassword) {
            showMessage('ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´', 'error');
            return;
        }
        
        const userData = {
            username: formData.get('username'),
            email: formData.get('email'),
            first_name: formData.get('first_name'),
            last_name: formData.get('last_name'),
            role: formData.get('role'),
            password: password
        };
        
        try {
            const response = await fetch('/api/users/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(userData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                showMessage(data.message, 'success');
                closeModal('userModal');
                loadUsers();
            } else {
                showMessage(data.error, 'error');
            }
            
        } catch (error) {
            console.error('åˆ›å»ºç”¨æˆ·å¤±è´¥:', error);
            showMessage('åˆ›å»ºç”¨æˆ·å¤±è´¥', 'error');
        }
    }

    // ç¼–è¾‘ç”¨æˆ·
    async function editUser(userId) {
        try {
            // å…ˆè·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
            const response = await fetch(`/api/users/${userId}/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            });
            
            const user = await response.json();
            
            if (user.error) {
                showMessage(user.error, 'error');
                return;
            }
            
            // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
            const modal = createUserModal(user);
            document.body.appendChild(modal);
            modal.style.display = 'block';
            
        } catch (error) {
            console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
            showMessage('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥', 'error');
        }
    }

    // æ›´æ–°ç”¨æˆ·
    async function updateUser(userId) {
        const form = document.getElementById('userForm');
        const formData = new FormData(form);
        
        const userData = {
            username: formData.get('username'),
            email: formData.get('email'),
            first_name: formData.get('first_name'),
            last_name: formData.get('last_name'),
            role: formData.get('role'),
            is_active: formData.get('is_active') === 'on'
        };
        
        // å¦‚æœè¾“å…¥äº†æ–°å¯†ç ï¼Œæ·»åŠ åˆ°æ•°æ®ä¸­
        const password = formData.get('password');
        if (password) {
            userData.password = password;
        }
        
        try {
            const response = await fetch(`/api/users/${userId}/update/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify(userData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                showMessage(data.message, 'success');
                closeModal('userModal');
                loadUsers();
            } else {
                showMessage(data.error, 'error');
            }
            
        } catch (error) {
            console.error('æ›´æ–°ç”¨æˆ·å¤±è´¥:', error);
            showMessage('æ›´æ–°ç”¨æˆ·å¤±è´¥', 'error');
        }
    }

    // åˆ é™¤ç”¨æˆ·
    async function deleteUser(userId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/users/${userId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showMessage(data.message, 'success');
                loadUsers();
            } else {
                showMessage(data.error, 'error');
            }
            
        } catch (error) {
            console.error('åˆ é™¤ç”¨æˆ·å¤±è´¥:', error);
            showMessage('åˆ é™¤ç”¨æˆ·å¤±è´¥', 'error');
        }
    }

    // åˆ‡æ¢ç”¨æˆ·çŠ¶æ€
    async function toggleUserStatus(userId) {
        try {
            const response = await fetch(`/api/users/${userId}/toggle-status/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                showMessage(data.message, 'success');
                loadUsers();
            } else {
                showMessage(data.error, 'error');
            }
            
        } catch (error) {
            console.error('åˆ‡æ¢ç”¨æˆ·çŠ¶æ€å¤±è´¥:', error);
            showMessage('åˆ‡æ¢ç”¨æˆ·çŠ¶æ€å¤±è´¥', 'error');
        }
    }

    // æ‰¹é‡æ“ä½œ
    function showBatchOperations() {
        if (selectedUsers.size === 0) {
            showMessage('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„ç”¨æˆ·', 'warning');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'batchModal';
        
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h2>æ‰¹é‡æ“ä½œ (å·²é€‰æ‹© ${selectedUsers.size} ä¸ªç”¨æˆ·)</h2>
                    <span class="close" onclick="closeModal('batchModal')">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="batch-actions">
                        <button class="btn btn-danger" onclick="batchDeleteUsers()">æ‰¹é‡åˆ é™¤</button>
                        <button class="btn btn-warning" onclick="batchDisableUsers()">æ‰¹é‡ç¦ç”¨</button>
                        <button class="btn btn-success" onclick="batchEnableUsers()">æ‰¹é‡æ¿€æ´»</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('batchModal')">å–æ¶ˆ</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        modal.style.display = 'block';
    }

    // æ‰¹é‡åˆ é™¤ç”¨æˆ·
    async function batchDeleteUsers() {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤è¿™ ${selectedUsers.size} ä¸ªç”¨æˆ·å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼`)) {
            return;
        }
        
        try {
            const response = await fetch('/api/users/batch-delete/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    user_ids: Array.from(selectedUsers)
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                let msg = data.message.replace(/(\d+)/, (m) => Math.floor(Number(m) / 2));
                showMessage(msg, 'success');
                selectedUsers.clear();
                closeModal('batchModal');
                loadUsers();
            } else {
                showMessage(data.error, 'error');
            }
            
        } catch (error) {
            console.error('æ‰¹é‡åˆ é™¤å¤±è´¥:', error);
            showMessage('æ‰¹é‡åˆ é™¤å¤±è´¥', 'error');
        }
    }

    // æ‰¹é‡æ¿€æ´»ç”¨æˆ·
    async function batchEnableUsers() {
        if (selectedUsers.size === 0) {
            showMessage('è¯·å…ˆé€‰æ‹©è¦æ¿€æ´»çš„ç”¨æˆ·', 'warning');
            return;
        }
        if (!confirm(`ç¡®å®šè¦æ¿€æ´»è¿™ ${selectedUsers.size} ä¸ªç”¨æˆ·å—ï¼Ÿ`)) {
            return;
        }
        try {
            const response = await fetch('/api/users/batch-enable/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    user_ids: Array.from(selectedUsers)
                })
            });
            const data = await response.json();
            if (data.success) {
                showMessage(data.message, 'success');
                selectedUsers.clear();
                closeModal('batchModal');
                loadUsers();
            } else {
                showMessage(data.error, 'error');
            }
        } catch (error) {
            console.error('æ‰¹é‡æ¿€æ´»å¤±è´¥:', error);
            showMessage('æ‰¹é‡æ¿€æ´»å¤±è´¥', 'error');
        }
    }

    // æ‰¹é‡ç¦ç”¨ç”¨æˆ·
    async function batchDisableUsers() {
        if (selectedUsers.size === 0) {
            showMessage('è¯·å…ˆé€‰æ‹©è¦ç¦ç”¨çš„ç”¨æˆ·', 'warning');
            return;
        }
        if (!confirm(`ç¡®å®šè¦ç¦ç”¨è¿™ ${selectedUsers.size} ä¸ªç”¨æˆ·å—ï¼Ÿ`)) {
            return;
        }
        try {
            const response = await fetch('/api/users/batch-disable/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    user_ids: Array.from(selectedUsers)
                })
            });
            const data = await response.json();
            if (data.success) {
                showMessage(data.message, 'success');
                selectedUsers.clear();
                closeModal('batchModal');
                loadUsers();
            } else {
                showMessage(data.error, 'error');
            }
        } catch (error) {
            console.error('æ‰¹é‡ç¦ç”¨å¤±è´¥:', error);
            showMessage('æ‰¹é‡ç¦ç”¨å¤±è´¥', 'error');
        }
    }

    // å¯¼å‡ºç”¨æˆ·æ•°æ®
    async function exportUsers() {
        try {
            const response = await fetch('/api/users/export/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                // åˆ›å»ºCSVå†…å®¹
                const csvContent = convertToCSV(data.data);
                
                // ä¸‹è½½æ–‡ä»¶
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `ç”¨æˆ·æ•°æ®_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showMessage('å¯¼å‡ºæˆåŠŸ', 'success');
            } else {
                showMessage(data.error, 'error');
            }
            
        } catch (error) {
            console.error('å¯¼å‡ºå¤±è´¥:', error);
            showMessage('å¯¼å‡ºå¤±è´¥', 'error');
        }
    }

    // è½¬æ¢ä¸ºCSVæ ¼å¼
    function convertToCSV(data) {
        if (!data || data.length === 0) return '';
        
        const headers = Object.keys(data[0]);
        const csvHeaders = headers.join(',');
        
        const csvRows = data.map(row => {
            return headers.map(header => {
                const value = row[header];
                // å¤„ç†åŒ…å«é€—å·çš„å€¼
                return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
            }).join(',');
        });
        
        return [csvHeaders, ...csvRows].join('\n');
    }

    // ç”¨æˆ·é€‰æ‹©ç®¡ç†
    function toggleUserSelection(userId) {
        if (selectedUsers.has(userId)) {
            selectedUsers.delete(userId);
        } else {
            selectedUsers.add(userId);
        }
        
        updateBatchButton();
    }

    function updateBatchButton() {
        const batchBtn = document.getElementById('batch-btn');
        if (batchBtn) {
            if (selectedUsers.size > 0) {
                batchBtn.textContent = `æ‰¹é‡æ“ä½œ (${selectedUsers.size})`;
                batchBtn.style.backgroundColor = '#007bff';
                batchBtn.style.color = 'white';
            } else {
                batchBtn.textContent = 'æ‰¹é‡æ“ä½œ';
                batchBtn.style.backgroundColor = '';
                batchBtn.style.color = '';
            }
        }
    }

    // åˆ†é¡µåŠŸèƒ½
    function updatePagination(data) {
        const pagination = document.getElementById('pagination');
        if (!pagination) return;
        
        pagination.innerHTML = '';
        
        // ä¸Šä¸€é¡µæŒ‰é’®
        const prevBtn = document.createElement('button');
        prevBtn.textContent = 'ä¸Šä¸€é¡µ';
        prevBtn.disabled = !data.has_previous;
        prevBtn.onclick = () => {
            if (data.has_previous) {
                currentPage--;
                loadUsers();
            }
        };
        pagination.appendChild(prevBtn);
        
        // é¡µç æŒ‰é’®
        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(data.total_pages, currentPage + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            const pageBtn = document.createElement('button');
            pageBtn.textContent = i;
            pageBtn.className = i === currentPage ? 'active' : '';
            pageBtn.onclick = () => {
                currentPage = i;
                loadUsers();
            };
            pagination.appendChild(pageBtn);
        }
        
        // ä¸‹ä¸€é¡µæŒ‰é’®
        const nextBtn = document.createElement('button');
        nextBtn.textContent = 'ä¸‹ä¸€é¡µ';
        nextBtn.disabled = !data.has_next;
        nextBtn.onclick = () => {
            if (data.has_next) {
                currentPage++;
                loadUsers();
            }
        };
        pagination.appendChild(nextBtn);
    }

    // å·¥å…·å‡½æ•°
    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.remove();
        }
    }

    function showMessage(message, type = 'info') {
        // åˆ›å»ºæ¶ˆæ¯æç¤º
        const messageDiv = document.createElement('div');
        messageDiv.className = `message message-${type}`;
        messageDiv.textContent = message;
        
        // æ ·å¼
        messageDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 4px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            transition: all 0.3s ease;
        `;
        
        // æ ¹æ®ç±»å‹è®¾ç½®é¢œè‰²
        switch(type) {
            case 'success':
                messageDiv.style.backgroundColor = '#28a745';
                break;
            case 'error':
                messageDiv.style.backgroundColor = '#dc3545';
                break;
            case 'warning':
                messageDiv.style.backgroundColor = '#ffc107';
                messageDiv.style.color = '#000';
                break;
            default:
                messageDiv.style.backgroundColor = '#17a2b8';
        }
        
        document.body.appendChild(messageDiv);
        
        // 3ç§’åè‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.parentNode.removeChild(messageDiv);
            }
        }, 3000);
    }

    function getCsrfToken() {
        const token = document.querySelector('[name=csrfmiddlewaretoken]');
        if (token) return token.value;
        
        // ä»cookieä¸­è·å–
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            const [name, value] = cookie.trim().split('=');
            if (name === 'csrftoken') {
                return value;
            }
        }
        return '';
    }

    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // æƒé™é…ç½®æ¨¡æ€æ¡†
    function showPermissionConfigModal() {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = 'permissionModal';
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h2>æƒé™é…ç½®</h2>
                    <span class="close" onclick="closeModal('permissionModal')">&times;</span>
                </div>
                <div class="modal-body">
                    <p>æƒé™é…ç½®åŠŸèƒ½å¼€å‘ä¸­...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('permissionModal')">å…³é—­</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
        modal.style.display = 'block';
    }
    </script>

    <style>
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 0;
        border: none;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-header h2 {
        margin: 0;
        color: #333;
    }

    .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover {
        color: #000;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-footer {
        padding: 20px;
        border-top: 1px solid #eee;
        text-align: right;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
    }

    .form-group input,
    .form-group select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
    }

    .batch-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .batch-actions .btn {
        flex: 1;
        min-width: 120px;
    }

    .user-checkbox {
        margin-right: 10px;
        transform: scale(1.2);
    }

    .action-buttons {
        display: flex;
        gap: 5px;
    }

    .action-icon {
        background: none;
        border: none;
        font-size: 16px;
        cursor: pointer;
        padding: 5px;
        border-radius: 3px;
        transition: background-color 0.2s;
    }

    .action-icon:hover {
        background-color: #f8f9fa;
    }

    .table-row {
        transition: background-color 0.2s;
    }

    .table-row:hover {
        background-color: #f8f9fa;
    }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background-color: #0056b3;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #545b62;
    }

    .btn-danger {
        background-color: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background-color: #c82333;
    }

    .btn-warning {
        background-color: #ffc107;
        color: #212529;
    }

    .btn-warning:hover {
        background-color: #e0a800;
    }

    .btn-success {
        background-color: #28a745;
        color: white;
    }

    .btn-success:hover {
        background-color: #1e7e34;
    }

    .pagination button {
        margin: 0 2px;
        padding: 8px 12px;
        border: 1px solid #ddd;
        background: white;
        cursor: pointer;
    }

    .pagination button:hover {
        background-color: #f8f9fa;
    }

    .pagination button.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }

    .pagination button:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }

    #loading {
        color: #666;
        font-style: italic;
    }

    .table-header > div:first-child {
        padding-left: 40px; /* å¯æ ¹æ®å®é™…éœ€è¦è°ƒæ•´æ•°å€¼ */
    }
    </style>
</body>
</html>